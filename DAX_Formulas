<-- Cumulative CEI -->
DECLARE @END_DATE date = eomonth(dateadd(month,-1,getdate()-1)), @START_DATE date = datefromparts(year(getdate()-1)-1,1,1);

-- cumulative CEI
with mon_cei as (
select eomonth(CREATED_DATE) MONTH_CREATED
		, count(CLIENT_ID) NUMB_OF_RESP
		, convert(decimal(10,2),avg(cast(LOAN_SERVICE_RATING as decimal))) AVG_RATING
from LOAN_APPLICATION
where LOAN_SERVICE_RATING IS NOT NULL and cast(CREATED_DATE as date) <= @END_DATE
group by eomonth(CREATED_DATE) 
),
cum_cei as (
select *
		, sum(NUMB_OF_RESP * AVG_RATING) over(order by MONTH_CREATED rows between 11 preceding and current row) WEIGHT
		, sum(NUMB_OF_RESP) over(order by MONTH_CREATED rows between 11 preceding and current row) CUM_RESP
from mon_cei
)

select *
		, WEIGHT / CUM_RESP CEI
from cum_cei
where MONTH_CREATED >= @START_DATE


<-- Cumulative NPS -->
DECLARE @END_DATE date = eomonth(dateadd(month,-1,getdate()-1)), @START_DATE date = datefromparts(year(getdate()-1)-1,1,1);

--cumulative NPS
with cat as (
select eomonth(CREATED_DATE) MONTH_CREATED
		, sum(case when PLATFORM_RATING >= 5 then 1 else 0 end) as 'Promoters'
		, sum(case when PLATFORM_RATING <= 3  then 1 else 0 end) as 'Detractors'
		, count(*) TotalRatings
from LOAN_APPLICATION
where PLATFORM_RATING IS NOT NULL and cast(CREATED_DATE as date) <= @END_DATE
group by eomonth(CREATED_DATE)
) ,
cat_cum as(
select *
		, sum(Promoters) over(order by MONTH_CREATED rows between 11 preceding and current row)  as CumPromoters
		, sum(Detractors) over(order by MONTH_CREATED rows between 11 preceding and current row) as CumDetractors
		, sum(TotalRatings) over(order by MONTH_CREATED rows between 11 preceding and current row) CumTotal
from cat

)


select *  
		, cast((CumPromoters - CumDetractors) as decimal) / CumTotal NPS
from cat_cum
where MONTH_CREATED >= @START_DATE
